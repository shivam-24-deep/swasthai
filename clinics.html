<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nearby Clinics | SwasthAI</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
    }
    #map {
      height: 100vh;
      width: 100%;
    }
    #search-input {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 5;
      width: 90%;
      max-width: 400px;
      padding: 10px;
      border-radius: 25px;
      border: 1px solid #ccc;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    @media (max-width: 600px) {
      #search-input {
        top: 5px;
        width: 95%;
      }
    }
  </style>
</head>
<body>
  <input id="search-input" type="text" placeholder="Search for hospital, clinic, etc..." />
  <div id="map"></div>

  <script>
    let map, userMarker, infoWindow, directionsService, directionsRenderer;

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 0, lng: 0 },
        zoom: 15,
      });
      infoWindow = new google.maps.InfoWindow();
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map: map });

      // Search box
      const input = document.getElementById("search-input");
      const searchBox = new google.maps.places.SearchBox(input);
      map.controls[google.maps.ControlPosition.TOP_CENTER].push(input);

      // Get current location
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
          const pos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude,
          };
          map.setCenter(pos);
          userMarker = new google.maps.Marker({
            position: pos,
            map,
            icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
            title: "You are here",
          });

          findNearbyPlaces(pos);
        });
      }

      // Handle search
      searchBox.addListener("places_changed", () => {
        const places = searchBox.getPlaces();
        if (places.length == 0) return;
        map.setCenter(places[0].geometry.location);
        findNearbyPlaces(places[0].geometry.location);
      });
    }

    function findNearbyPlaces(location) {
      const service = new google.maps.places.PlacesService(map);
      const request = {
        location: location,
        radius: 5000,
        type: ["hospital"]
      };
      service.nearbySearch(request, (results, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
          results.forEach((place) => {
            const marker = new google.maps.Marker({
              map,
              position: place.geometry.location,
              title: place.name,
            });

            marker.addListener("click", () => {
              service.getDetails({ placeId: place.place_id }, (details, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                  let content = `
                    <strong>${details.name}</strong><br>
                    ${details.formatted_address || "Address not available"}<br>
                    ${details.formatted_phone_number || ""}<br>
                    ${details.opening_hours?.weekday_text?.join('<br>') || ""}<br>
                    <a href="https://www.google.com/maps/dir/?api=1&origin=${userMarker.getPosition().lat()},${userMarker.getPosition().lng()}&destination=${details.geometry.location.lat()},${details.geometry.location.lng()}&travelmode=driving" target="_blank">Get Directions</a>
                  `;
                  infoWindow.setContent(content);
                  infoWindow.open(map, marker);
                  map.panTo(details.geometry.location);
                }
              });
            });
          });
        }
      });
    }
  </script>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAQlJvbdO-nJov7fEr3cY9LZzRJKcf6-kI&libraries=places&callback=initMap" async defer></script>
</body>
</html>
